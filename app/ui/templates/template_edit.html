{% extends "layout.html" %}
{% set active = "templates" %}
{% set title = "Template" %}
{% if tpl %}
  {% set subtitle = "Edit: " ~ tpl.name %}
{% else %}
  {% set subtitle = "Create a new template" %}
{% endif %}

{% block topbar %}
  <a class="btn" href="/templates">Back</a>
{% endblock %}

{% block content %}
  {% if error %}
    <div class="alert">{{ error }}</div>
  {% endif %}

  <div class="card">
    <form method="post" action="/templates/save" class="form">
      <input type="hidden" name="tpl_id" value="{{ tpl.id if tpl else '' }}" />

      <div class="grid-2">
        <div>
          <label>Name</label>
          <input type="text" name="name" value="{{ tpl.name if tpl else '' }}" placeholder="Invoice (ACME)" required />
        </div>
        <div>
          <label>Enabled</label>
          <div class="toggle">
            <input type="checkbox" name="enabled" {% if tpl and tpl.enabled %}checked{% elif not tpl %}checked{% endif %} />
            <span class="muted">Template will be used for matching</span>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Doc type (becomes a tag)</label>
          <input type="text" name="doc_type" value="{{ tpl.doc_type if tpl else 'Document' }}" placeholder="Invoice" />
        </div>
        <div>
          <label>Base folder (within /data/library)</label>
          <input type="text" name="doc_folder" value="{{ tpl.doc_folder if tpl else 'Inbox' }}" list="folders" />
          <datalist id="folders">
            {% for p in library_dirs %}
              <option value="{{ p }}"></option>
            {% endfor %}
          </datalist>
          <div class="hint muted">Tip: this list is built from your existing folder tree.</div>
        </div>
      </div>

      <label>Tags (comma separated)</label>
      <input type="text" name="tags" value="{{ tpl.tags()|join(', ') if tpl else '' }}" placeholder="invoice, utilities, acme" />

      <div class="hr"></div>

      <div class="grid-2">
        <div>
          <label>Match mode</label>
          <select name="match_mode">
            <option value="all" {% if tpl and tpl.match_mode=='all' %}selected{% endif %}>All patterns must match</option>
            <option value="any" {% if tpl and tpl.match_mode=='any' %}selected{% endif %}>Any pattern can match</option>
          </select>
        </div>
        <div>
          <label>Match patterns (one per line, regex)</label>
          <textarea name="match_patterns" rows="6" placeholder="\binvoice\b">{{ "\n".join(tpl.match_patterns()) if tpl else "" }}</textarea>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid-2">
        <div>
          <label>Company regex (group 1 preferred)</label>
          <input type="text" name="company_regex" value="{{ tpl.company_regex if tpl else '' }}" placeholder="(?i)Supplier:\s*(.+)" />
        </div>
        <div>
          <label>Invoice number regex (group 1 preferred)</label>
          <input type="text" name="invoice_number_regex" value="{{ tpl.invoice_number_regex if tpl else '' }}" placeholder="(?i)Invoice\s*No\s*[:#]?\s*([A-Z0-9\-\/]+)" />
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Date regex (group 1 preferred)</label>
          <input type="text" name="date_regex" value="{{ tpl.date_regex if tpl else '' }}" placeholder="(?i)(?:Invoice\s*Date|Date)\s*[:]?\s*([0-9]{1,2}[-/.][0-9]{1,2}[-/.][0-9]{2,4})" />
        </div>
        <div>
          <label>Output path template</label>
          <input type="text" name="output_path_template" value="{{ tpl.output_path_template if tpl else '{doc_folder}/{company}/{date:%Y}' }}" />
          <div class="hint muted">Supports {doc_folder}, {company}, {invoice_number}, {original_name}, {date:%Y-%m-%d}</div>
        </div>
      </div>

      <label>Filename template</label>
      <input type="text" name="filename_template" value="{{ tpl.filename_template if tpl else '{company}_{invoice_number}_{date:%Y-%m-%d}' }}" />

      <div class="hr"></div>

      <button class="btn primary" type="submit">Save template</button>
    </form>
  </div>
{% endblock %}
